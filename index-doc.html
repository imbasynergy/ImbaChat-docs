<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Документация ImbaChat</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
	<link href="style.css" rel="stylesheet">
</head>
<body>
	<h1>Интеграция плагина</h1>
	<div class="sec sec-1">
		<h2 class="sec__title">Настройка плагина на нашем сайте</h2>
		<div class="sec__content">
			<ul class="sec__block">
				<li class="sec__par">1. Зарегистирируйтесь на сайте http://dev2.imbachat.com.</li>
				<li class="sec__par">
					2. Зайдите на страницу с виджетами ( http://dev2.imbachat.com/admin/widgets ). Нажмите "создать" и заполните поля:
					<ul class="sec__sub-block">
						<li class="sec__sub-par">"Секретный ключ" - секретный ключ для формирования <a class="target-link" href="#getJWT">JWT токенa</a>.</li>
						<li class="sec__sub-par">"Out password" - логин и пароль для аутентификации разрабочтика. Логин и пароль нужно вводить через двоеточие.</li>
						<li class="sec__sub-par">"Debug" - включает режим отладки (Не рекомендуется включать).</li>
						<li class="sec__sub-par">"URL для получения пользователей" - этот URL должен вызывавать <a class="target-link" href="#getUser">функцию, которую вы напишите на своей серверной части</a>.</li>
						<li class="sec__sub-par">"Символ разделения" - разделяет строку с id пользователей, в <a class="target-link" href="#getUser">функции получения пользователей</a></li>
						<li class="sec__sub-par">"URL для авторизации пользователя через логин и пароль"</li>
						<li class="sec__sub-par">"Имя"</li>
						<li class="sec__sub-par">"no_password" - отключает проверку авторизации (Не рекомендуется включать).</li>
					</ul>
				</li>
				<li class="sec__par">3. Нажмиет "Создать".</li>
				
			</ul>
		</div>
	</div>
	<div class="sec sec-1">
		<h2 class="sec__title">Frontend</h2>
		<div class="sec__content">
			<ul class="sec__block">
				<li class="sec__par">1. Для начала нужно подключить javascript ImbaChat'а. Подключение выглядит так <span class="acc">&lt;script src="http://dev2.imbachat.com/imbachat/v1/<span class="acc-sub">DEV_ID</span>/widget"&gt;&lt;/script&gt;</span>, где вместо <span class="acc"><span class="acc-sub">DEV_ID</span></span> id виджета ( смотрите на странице виджета ).</li>
				<li class="sec__par">2. Далее мы вставляем скрипт загрузки чата
<span class="acc acc-script">
	<pre>
	function imbachatWidget(){
	    if(!window.ImbaChat){
	        return setTimeout(imbachatWidget, 50)
	    }

	    window.ImbaChat.load(<span class="acc-sub">PARAMETRS</span>);
	}
	imbachatWidget();
	</pre>
</span>
					Вместо <span class="acc"><span class="acc-sub">PARAMETRS</span></span> должны быть параметры такого вида:
<span class="acc acc-script">
	<pre>
	{
		user_id: <span class="acc-cursive">id текущего пользователя</span>,
		token: <span class="acc-cursive"><a class="target-link" href="#getJWT">JWT токен</a></span>
	}
	</pre>
</span>
				</li>
			</ul>
			<div class="warning">Важно! Скрипт должен подключаться после подключаемого вами Jquery.</div>
		</div>
	</div>
	<div class="sec sec-1">
		<h2 class="sec__title">Backend</h2>
		<div class="sec__content">
			<div class="sec__block-v2" id="getUser">
				<h3 class="sec__title">Функция позволяющая получить информацию о пользователях для ImbaChat.</h3>
<span class="acc acc-script">
	<pre>
	public function getUser($str_ids){
		//<span class="acc-cursive">Логин и пароль разработчика</span>
	        $login = \Config::get('imbasynergy.imbachatwidget::login');
	        $password = \Config::get('imbasynergy.imbachatwidget::password');

		//<span class="acc-cursive">Аутентификация разработчика</span>
	        if(!isset($_SERVER['PHP_AUTH_USER']) || ($_SERVER['PHP_AUTH_PW']!=$password) || strtolower($_SERVER['PHP_AUTH_USER'])!=$login)
	        {
	            header('WWW-Authenticate: Basic realm="Backend"');
	            header('HTTP/1.0 401 Unauthorized');
	            echo 'Authenticate required!';
	            die();
	        }

		//<span class="acc-cursive">Разделение строки с id пользователей, через символ, который вы прописали в поле "Символ разделения"</span>
	        $ids = explode("<span class="acc-cursive">cимвол разделения</span>", $str_ids);
	        $users = array();

	        //<span class="acc-cursive">Заполнение массива с пользователями</span>
	        foreach ($ids as $id){
	            $user_m = <span class="acc-cursive">Получение пользователя по id</span>;
	            $user = array();
	            $user['name'] = <span class="acc-cursive">Имя пользователя</span>;
	            $user['user_id'] = $id;
	            $user['avatar_url'] = <span class="acc-cursive">Аватар пользователя ( не обязательно )</span>;
	            $users[] = $user;
	        }
	        return json_encode($users);
	}
	</pre>
</span>
			</div>
			<div class="sec__block-v2" id="getJWT">
				<h3 class="sec__title">Функция отдающая JWT токен.</h3>
<span class="acc acc-script">
	<pre>
	function getJWT(){

		// <span class="acc-cursive">Create token header as a JSON string</span>
	        $header = json_encode(['typ' => 'JWT', 'alg' => 'HS256']);
	        $pass = <span class="acc-cursive">Секретный ключ</span>;
	        $data = array();
	        $data['exp'] = (int)date('U')+3600*7;
	        $data['user_id'] = <span class="acc-cursive">id текущего пользователя</span>;

	        if(isset($data['user_id']))
	        {
	            $data['user_id'] = (int)$data['user_id'];
	        }

		// <span class="acc-cursive">Create token payload as a JSON string</span>
	        $payload = json_encode($data);

		// <span class="acc-cursive">Encode Header to Base64Url String</span>
	        $base64UrlHeader = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($header));

		// <span class="acc-cursive">Encode Payload to Base64Url String</span>
	        $base64UrlPayload = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($payload));

		// <span class="acc-cursive">Create Signature Hash</span>
	        $signature = hash_hmac('sha256', $base64UrlHeader . "." . $base64UrlPayload, $pass, true);

		// <span class="acc-cursive">Encode Signature to Base64Url String</span>
	        $base64UrlSignature = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($signature));

		// <span class="acc-cursive">Create JWT</span>
	        return trim($base64UrlHeader . "." . $base64UrlPayload . "." . $base64UrlSignature);
	}
	</pre>
</span>
			</div>
		</div>
	</div>
</body>
</html>
